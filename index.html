<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIキャプションメーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #FDFDFD;
            color: #4A4A4A;
        }
        .button {
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #E0D9C8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #imageAnalysisResult, #uploadedImage, .extra-content-card {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dot-pulse {
            position: relative;
            left: -9999px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #0E4D92;
            color: #0E4D92;
            box-shadow: 9999px 0 0 -5px;
            animation: dot-pulse 1.5s infinite linear;
            animation-delay: .25s;
        }
        .dot-pulse::before, .dot-pulse::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #0E4D92;
            color: #0E4D92;
        }
        .dot-pulse::before {
            box-shadow: 9984px 0 0 -5px;
            animation: dot-pulse-before 1.5s infinite linear;
            animation-delay: 0s;
        }
        @keyframes dot-pulse-before {
            0% { box-shadow: 9984px 0 0 -5px; }
            30% { box-shadow: 9984px 0 0 2px; }
            60%, 100% { box-shadow: 9984px 0 0 -5px; }
        }
        .dot-pulse::after {
            box-shadow: 10014px 0 0 -5px;
            animation: dot-pulse-after 1.5s infinite linear;
            animation-delay: .5s;
        }
        @keyframes dot-pulse-after {
            0% { box-shadow: 10014px 0 0 2px; }
            30% { box-shadow: 10014px 0 0 -5px; }
            60%, 100% { box-shadow: 10014px 0 0 -5px; }
        }
        @keyframes dot-pulse {
            0% { box-shadow: 9999px 0 0 -5px; }
            30% { box-shadow: 9999px 0 0 2px; }
            60%, 100% { box-shadow: 9999px 0 0 -5px; }
        }
        .caption-text {
            font-family: 'Noto Serif JP', serif;
        }
        .sns-post {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #eee;
        }
    </style>
</head>
<body class="antialiased flex flex-col items-center min-h-screen p-3 sm:p-4">
    <main class="w-full max-w-4xl text-center bg-gray-100 p-4 sm:p-8 rounded-lg shadow-inner card">
        <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 sm:mb-6 text-[#4A4A4A]">✨ AIキャプションメーカー ✨</h2>
        <p class="text-sm sm:text-lg mb-6 sm:mb-8 text-[#6B6B6B]">第70回記念表美展に出展するあなたの作品をアップロードして、AIに「温故創新」のテーマに沿ったキャプションを生成してもらいましょう。</p>

        <!-- Image Preview Section -->
        <div id="imagePreviewContainer" class="mb-6 sm:mb-8 hidden">
            <img id="uploadedImage" class="max-h-[250px] sm:max-h-[400px] w-auto h-auto rounded-lg shadow-md mx-auto object-contain">
        </div>

        <div class="space-y-4 sm:space-y-6">
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ステップ1: 作品の写真をアップロード</p>
                <div class="flex flex-col items-center justify-center">
                    <label for="imageInput" class="button inline-block py-2 px-5 sm:py-3 sm:px-6 rounded-md bg-[#0E4D92] text-white cursor-pointer hover:bg-[#1263B7]">
                        <span id="fileName">ファイルを選択</span>
                    </label>
                    <input type="file" id="imageInput" accept="image/*" onchange="displayFileName(event)" class="hidden">
                </div>
            </div>
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ステップ2: 作品に関するキーワードを入力</p>
                <textarea id="keywordsInput" class="w-full h-24 p-2 rounded-md border border-gray-300 resize-none focus:outline-none focus:ring-2 focus:ring-[#0E4D92] transition-all" placeholder="例：伝統的な技法、未来的なデザイン、静寂、光と影"></textarea>
            </div>
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ステップ3: キャプションを生成</p>
                <button onclick="analyzeImage()" class="button w-full py-2 px-5 sm:py-3 sm:px-6 bg-[#0E4D92] text-white rounded-md hover:bg-[#1263B7]">
                    キャプションを生成する
                </button>
            </div>
        </div>
        <div id="imageAnalysisResult" class="mt-8 text-left p-4 sm:p-6 rounded-lg card min-h-[100px] flex items-center justify-center">
            <p class="text-gray-400">ここにAIによるキャプションが表示されます。</p>
        </div>
    </main>

    <footer class="mt-8 text-center text-xs text-gray-500">
        <p>2025 京都表具協同組合 All Rights Reserved.</p>
    </footer>

    <script>
        // ---全体で使う変数の設定---
        const API_KEY = "AIzaSyBmuD2c_M6Kg_GRk7TJpqXGNzsZGH3FeME";
        let currentImageBase64 = null;
        let currentKeywords = "";
        let currentMimeType = null;
        let audioContext = null; // ★★★ スマートフォン対応のための音声コンテキスト

        // ---AIに渡す参考資料---
        const EXHIBITION_DOCUMENT = `第70回記念表美展 開催要項...`; // 省略

        // ---画面の操作に関する関数---
        function displayFileName(event) {
            const fileInput = event.target;
            const fileNameSpan = document.getElementById('fileName');
            const uploadedImage = document.getElementById('uploadedImage');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const file = fileInput.files[0];

            if (file) {
                fileNameSpan.textContent = file.name;
                uploadedImage.src = URL.createObjectURL(file);
                imagePreviewContainer.classList.remove('hidden');
            } else {
                fileNameSpan.textContent = 'ファイルを選択';
                imagePreviewContainer.classList.add('hidden');
            }
        }
        
        // ★★★ スマートフォンでの音声再生を有効化するための初期化関数 ★★★
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // iOSなどで再生を有効化するため、空の音を再生する
                    if (audioContext.state === 'suspended') {
                         const buffer = audioContext.createBuffer(1, 1, 22050);
                         const source = audioContext.createBufferSource();
                         source.buffer = buffer;
                         source.connect(audioContext.destination);
                         source.start(0);
                    }
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                }
            }
        }
        // 最初のユーザー操作で音声機能を初期化
        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('touchend', initAudio, { once: true });


        // ---AIとの通信に関するメインの関数---
        async function analyzeImage() {
            const fileInput = document.getElementById('imageInput');
            const keywordsInput = document.getElementById('keywordsInput');
            const file = fileInput.files[0];
            const keywords = keywordsInput.value;
            const resultDiv = document.getElementById('imageAnalysisResult');
            const generateButton = document.querySelector('button');

            if (!file) {
                resultDiv.innerHTML = '<p class="text-red-500">画像をアップロードしてください。</p>';
                return;
            }

            resultDiv.innerHTML = '<div class="flex flex-col items-center space-y-2"><div class="dot-pulse"></div><p class="text-sm text-gray-500">AIが作品を分析中です。完了までしばらくお待ちください。</p></div>';
            generateButton.disabled = true;

            const reader = new FileReader();
            reader.onloadend = async () => {
                currentImageBase64 = reader.result.split(',')[1];
                currentKeywords = keywords;
                currentMimeType = file.type;
                
                const prompt = `以下のドキュメントを参考に、この画像に写っている第70回記念表美展に出展する私の作品について、作者である表具師本人の目線で、3つの異なるキャプション案を生成してください。

ドキュメント:
"${EXHIBITION_DOCUMENT}"

私の作品について、一人の表具師として、長年培ってきた技術や素材へのこだわり、そして「伝統的なものから新しい価値を生み出す」というテーマへの挑戦が伝わるように、キャプションを作成してください。作品の画像から読み取れる特徴（色、形、質感、構図、雰囲気など）に具体的に触れつつ、表具師ならではの専門的な視点や、作品に込めた精神性を語ってください。
1つ目の案は、作品の**技術や素材の面白さ**、**形や色の美しさ**に点を当て、少し文学的で深みのある表現を使って、私がこの作品に込めた思いを説明してください。
2つ目の案は、作品が持つ**物語性**や**感動的な側面**、**見る人に語りかけるメッセージ**に焦点を当て、共感を呼ぶような表現で、私がこの作品を通して伝えたいことを説明してください。
3つ目の案は、作品の**見た目のインパクト**と、そこから生まれる**新しい表現の可能性**に焦点を当て、展示の場で目を引くような力強い表現で、私の表現への挑戦を説明してください。

重要: 各キャプションは、展覧会場で来場者が読みやすいように、100文字から150文字程度の簡潔さでお願いします。各キャプションは独立した文章として完結させ、見出しや箇条書きは含めないでください。
「温故創新」という言葉を直接使わないでください。

${keywords ? `\n以下のキーワードをキャプションに反映させてください: ${keywords}` : ''}`;
                    
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: currentMimeType, data: currentImageBase64 } }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: { "caption": { "type": "STRING" } },
                                "propertyOrdering": ["caption"]
                            }
                        }
                    }
                };

                try {
                    const result = await fetchWithRetry(apiUrl, payload);
                    
                    if (!result) throw new Error('APIから空の応答を受け取りました。');
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const rawJsonText = result.candidates[0].content.parts[0].text;
                        let captions;
                        try {
                            captions = JSON.parse(rawJsonText);
                        } catch (e) {
                            const jsonMatch = rawJsonText.match(/\[\s*\{[\s\S]*\}\s*\]/);
                            if (jsonMatch && jsonMatch[0]) { captions = JSON.parse(jsonMatch[0]); } 
                            else { throw new Error('API応答に有効なJSONブロックが見つかりませんでした。'); }
                        }
                        
                        if (!Array.isArray(captions) || captions.length < 3 || !captions[0].caption) {
                            throw new Error('無効なJSON構造です。');
                        }

                        let resultHtml = `
                            <div class="space-y-6">
                                ${captions.map((item, index) => `
                                    <div class="p-4 rounded-md card">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                            <h3 class="font-bold text-md sm:text-lg text-left text-[#4A4A4A]">キャプション案${index + 1}</h3>
                                            <div class="flex space-x-2 self-end sm:self-auto">
                                                <button onclick="copyToClipboard(this)" class="button text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors whitespace-nowrap">コピー</button>
                                                <button onclick="downloadCaption(\`${escapeHtml(item.caption)}\`, ${index + 1})" class="button text-sm px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors whitespace-nowrap">💾 テキストの保存</button>
                                                <button onclick="startChat(${index}, \`${escapeHtml(item.caption)}\`)" class="button text-sm px-3 py-1 bg-[#0E4D92] text-white rounded-md hover:bg-[#1263B7] whitespace-nowrap">AIとチャット</button>
                                            </div>
                                        </div>
                                        <p class="mt-4 text-left caption-text" data-index="${index}">${escapeHtml(item.caption)}</p>
                                        <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 justify-between items-center">
                                            <div class="flex items-center gap-2">
                                                <button onclick="speakText(this, \`${escapeHtml(item.caption)}\`, 'ja-JP')" class="button text-sm px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">🔊 日本語ナレーション</button>
                                                <button onclick="downloadStoredAudio(this)" data-lang="ja-JP" disabled class="button text-sm px-3 py-1 bg-gray-400 text-white rounded-md">💾 保存</button>
                                                <button onclick="speakText(this, \`${escapeHtml(item.caption)}\`, 'en-US')" class="button text-sm px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">🔊 英語ナレーション</button>
                                                <button onclick="downloadStoredAudio(this)" data-lang="en-US" disabled class="button text-sm px-3 py-1 bg-gray-400 text-white rounded-md">💾 保存</button>
                                            </div>
                                            <button onclick="generateSocialMediaPost(${index}, \`${escapeHtml(item.caption)}\`)" class="button text-sm px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">✨ SNS投稿を作成</button>
                                        </div>
                                        <div id="extra-content-${index}" class="mt-4 text-left"></div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        resultDiv.innerHTML = resultHtml;

                    } else { throw new Error('APIから有効な応答がありませんでした。'); }
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    let errorMessage;
                    if (error.message && error.message.includes('403')) {
                        errorMessage = `<div class="text-left">...</div>`;
                    } else { errorMessage = `<p class="text-red-500">キャプションの生成中にエラーが発生しました。詳細: ${error.message}</p>`; }
                    resultDiv.innerHTML = errorMessage;
                } finally {
                    generateButton.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }
        
        // ---AIとのチャット機能に関する関数---
        async function startChat(captionIndex, initialCaption) { /* ... 省略 ... */ }
        async function sendChatMessage() { /* ... 省略 ... */ }

        // --- SNS投稿機能 ---
        async function generateSocialMediaPost(index, caption) { /* ... 省略 ... */ }
        async function startSocialChat(captionIndex, initialPost) { /* ... 省略 ... */ }
        async function sendSocialChatMessage() { /* ... 省略 ... */ }
        
        // ---補助的な関数---
        
        // ★★★ 音声出力機能 (Gemini TTS API版) ★★★
        async function speakText(buttonElement, text, lang) {
            initAudio(); // 念のため、ここでも呼び出す
            
            if (!audioContext) {
                const errorSpan = document.createElement('span');
                errorSpan.className = 'text-xs text-red-500 ml-2';
                errorSpan.textContent = '音声再生に非対応です';
                buttonElement.after(errorSpan);
                setTimeout(() => { errorSpan.remove(); }, 3000);
                buttonElement.disabled = true;
                return;
            }
             if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            const originalButtonText = buttonElement.textContent;
            const downloadBtn = buttonElement.nextElementSibling;
            let textToSpeak = text;

            try {
                if (lang.startsWith('en')) {
                    buttonElement.textContent = "翻訳中...";
                    buttonElement.disabled = true;
                    const translatedText = await translateText(text, 'en');
                    if (!translatedText) throw new Error('翻訳に失敗しました。');
                    textToSpeak = translatedText;
                }
                
                buttonElement.textContent = "音声生成中...";
                buttonElement.disabled = true;
                if (downloadBtn) downloadBtn.disabled = true;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
                const prompt = lang.startsWith('ja') 
                    ? `これは美術作品の解説文です。文脈に注意して、特に漢字の読み方（音読み、訓読み）が正確になるように、親しみやすく、抑揚をつけて読んでください: ${textToSpeak}`
                    : `Read this with a friendly and expressive tone: ${textToSpeak}`;
                const payload = {
                    model: "gemini-2.5-flash-preview-tts",
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: lang.startsWith('ja') ? "Puck" : "Callirrhoe" }
                            }
                        }
                    }
                };

                const result = await fetchWithRetry(apiUrl, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("MIMEタイプからサンプルレートを取得できませんでした。");
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const arrayBuffer = await wavBlob.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    source.start(0);

                    if (downloadBtn) {
                        const audioUrl = URL.createObjectURL(wavBlob);
                        downloadBtn.dataset.audioUrl = audioUrl;
                        downloadBtn.disabled = false;
                    }

                } else {
                    throw new Error("APIから有効な音声データが返されませんでした。");
                }

            } catch (error) {
                console.error("音声生成エラー:", error);
                const errorSpan = document.createElement('span');
                errorSpan.className = 'text-xs text-red-500 ml-2';
                errorSpan.textContent = '音声生成に失敗';
                buttonElement.after(errorSpan);
                setTimeout(() => { errorSpan.remove(); }, 3000);
            } finally {
                buttonElement.textContent = originalButtonText;
                buttonElement.disabled = false;
            }
        }
        
        function downloadStoredAudio(buttonElement) { /* ... 省略 ... */ }
        function downloadCaption(text, index) { /* ... 省略 ... */ }
        function base64ToArrayBuffer(base64) { /* ... 省略 ... */ }
        function pcmToWav(pcmData, sampleRate) { /* ... 省略 ... */ }
        function writeString(view, offset, string) { /* ... 省略 ... */ }
        async function translateText(text, targetLang) { /* ... 省略 ... */ }
        function resetApp() { /* ... 省略 ... */ }
        async function fetchWithRetry(url, payload, retries = 3) { /* ... 省略 ... */ }
        function copyToClipboard(buttonElement) { /* ... 省略 ... */ }
        function clearExtraContent(index) { /* ... 省略 ... */ }
        function escapeHtml(unsafe) { /* ... 省略 ... */ }
    </script>
</body>
</html>


