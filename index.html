<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #FDFDFD;
            color: #4A4A4A;
        }
        .button {
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #E0D9C8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #imageAnalysisResult, #uploadedImage, .extra-content-card {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dot-pulse {
            position: relative;
            left: -9999px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #0E4D92;
            color: #0E4D92;
            box-shadow: 9999px 0 0 -5px;
            animation: dot-pulse 1.5s infinite linear;
            animation-delay: .25s;
        }
        .dot-pulse::before, .dot-pulse::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #0E4D92;
            color: #0E4D92;
        }
        .dot-pulse::before {
            box-shadow: 9984px 0 0 -5px;
            animation: dot-pulse-before 1.5s infinite linear;
            animation-delay: 0s;
        }
        @keyframes dot-pulse-before {
            0% { box-shadow: 9984px 0 0 -5px; }
            30% { box-shadow: 9984px 0 0 2px; }
            60%, 100% { box-shadow: 9984px 0 0 -5px; }
        }
        .dot-pulse::after {
            box-shadow: 10014px 0 0 -5px;
            animation: dot-pulse-after 1.5s infinite linear;
            animation-delay: .5s;
        }
        @keyframes dot-pulse-after {
            0% { box-shadow: 10014px 0 0 2px; }
            30% { box-shadow: 10014px 0 0 -5px; }
            60%, 100% { box-shadow: 10014px 0 0 -5px; }
        }
        @keyframes dot-pulse {
            0% { box-shadow: 9999px 0 0 -5px; }
            30% { box-shadow: 9999px 0 0 2px; }
            60%, 100% { box-shadow: 9999px 0 0 -5px; }
        }
        .caption-text {
            font-family: 'Noto Serif JP', serif;
        }
        .sns-post {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #eee;
        }
    </style>
</head>
<body class="antialiased flex flex-col items-center min-h-screen p-3 sm:p-4">
    <main class="w-full max-w-4xl text-center bg-gray-100 p-4 sm:p-8 rounded-lg shadow-inner card">
        <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 sm:mb-6 text-[#4A4A4A]">âœ¨ AIã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ âœ¨</h2>
        <p class="text-sm sm:text-lg mb-6 sm:mb-8 text-[#6B6B6B]">ç¬¬70å›è¨˜å¿µè¡¨ç¾å±•ã«å‡ºå±•ã™ã‚‹ã‚ãªãŸã®ä½œå“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€AIã«ã€Œæ¸©æ•…å‰µæ–°ã€ã®ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚</p>

        <!-- Image Preview Section -->
        <div id="imagePreviewContainer" class="mb-6 sm:mb-8 hidden">
            <img id="uploadedImage" class="max-h-[250px] sm:max-h-[400px] w-auto h-auto rounded-lg shadow-md mx-auto object-contain">
        </div>

        <div class="space-y-4 sm:space-y-6">
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ã‚¹ãƒ†ãƒƒãƒ—1: ä½œå“ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                <div class="flex flex-col items-center justify-center">
                    <label for="imageInput" class="button inline-block py-2 px-5 sm:py-3 sm:px-6 rounded-md bg-[#0E4D92] text-white cursor-pointer hover:bg-[#1263B7]">
                        <span id="fileName">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                    </label>
                    <input type="file" id="imageInput" accept="image/*" onchange="displayFileName(event)" class="hidden">
                </div>
            </div>
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ã‚¹ãƒ†ãƒƒãƒ—2: ä½œå“ã«é–¢ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                <textarea id="keywordsInput" class="w-full h-24 p-2 rounded-md border border-gray-300 resize-none focus:outline-none focus:ring-2 focus:ring-[#0E4D92] transition-all" placeholder="ä¾‹ï¼šä¼çµ±çš„ãªæŠ€æ³•ã€æœªæ¥çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€é™å¯‚ã€å…‰ã¨å½±"></textarea>
            </div>
            <div class="text-left p-4 sm:p-6 rounded-lg card">
                <p class="text-sm mb-4 font-semibold">ã‚¹ãƒ†ãƒƒãƒ—3: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ</p>
                <button onclick="analyzeImage()" class="button w-full py-2 px-5 sm:py-3 sm:px-6 bg-[#0E4D92] text-white rounded-md hover:bg-[#1263B7]">
                    ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹
                </button>
            </div>
        </div>
        <div id="imageAnalysisResult" class="mt-8 text-left p-4 sm:p-6 rounded-lg card min-h-[100px] flex items-center justify-center">
            <p class="text-gray-400">ã“ã“ã«AIã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </main>

    <footer class="mt-8 text-center text-xs text-gray-500">
        <p>2025 äº¬éƒ½è¡¨å…·å”åŒçµ„åˆ All Rights Reserved.</p>
    </footer>

    <script>
        // ---å…¨ä½“ã§ä½¿ã†å¤‰æ•°ã®è¨­å®š---
        const API_KEY = "AIzaSyBmuD2c_M6Kg_GRk7TJpqXGNzsZGH3FeME";
        let currentImageBase64 = null;
        let currentKeywords = "";
        let currentMimeType = null;
        let audioContext = null; // â˜…â˜…â˜… ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œã®ãŸã‚ã®éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

        // ---AIã«æ¸¡ã™å‚è€ƒè³‡æ–™---
        const EXHIBITION_DOCUMENT = `ç¬¬70å›è¨˜å¿µè¡¨ç¾å±• é–‹å‚¬è¦é …
ã€Œæ¸©æ•…å‰µæ–°-Innovation from the pastã€
é–‹å‚¬æ¦‚è¦
ä¸»å‚¬ : äº¬éƒ½è¡¨å…·å”åŒçµ„åˆ
å¾Œæ´ : äº¬éƒ½åºœã€äº¬éƒ½å¸‚ã€äº¬éƒ½åºœä¸­å°ä¼æ¥­å›£ä½“ä¸­å¤®ä¼šã€äº¬éƒ½å•†å·¥ä¼šè­°æ‰€ã€è¿‘ç•¿çµŒæ¸ˆç”£æ¥­å±€ã€ä¸€èˆ¬è²¡å›£æ³•äººä¼çµ±çš„å·¥èŠ¸å“ç”£æ¥­æŒ¯èˆˆå”ä¼šã€äº¬éƒ½æ–°èã€KBSäº¬éƒ½
å”è³› : äº¬éƒ½åºœè·æ¥­èƒ½åŠ›é–‹ç™ºå”ä¼šã€å…¨å›½è¡¨å…·çµŒå¸«å†…è£…çµ„åˆé€£åˆä¼šã€è¥¿æ—¥æœ¬è¡¨å…·å†…è£…å”ä¼šã€äº¬è¡¨å…·å”åŒçµ„åˆé€£åˆä¼šã€äº¬éƒ½ä¼çµ±å·¥èŠ¸å”è­°ä¼š
ä¼šå ´ : äº¬éƒ½å¸‚å‹§æ¥­é¤¨ ã¿ã‚„ã“ã‚ã£ã›åœ°éšAå±•ç¤ºå®¤ (ã€’606-8343 äº¬éƒ½å¸‚å·¦äº¬åŒºå²¡å´æˆå‹å¯ºç”º90-1)
ä¼šæœŸ : ä»¤å’Œ7å¹´10æœˆ18æ—¥(åœŸ)ï½19æ—¥(æ—¥) 10:00ï½17:00
æ¬å…¥ : ä»¤å’Œ7å¹´10æœˆ17æ—¥(é‡‘)
ãƒ†ãƒ¼ãƒ : ã€Œæ¸©æ•…å‰µæ–°-Innovation from the pastã€
é–‹å‚¬ç›®çš„
è¡¨å…·ãŠã‚ˆã³å†…è£…æŠ€è¡“ã®ã•ã‚‰ãªã‚‹å‘ä¸Šã‚’ç›®æŒ‡ã—ã€ãƒ‡ã‚¸ã‚¿ãƒ«äº‹æ¥­ã¨ã®é€£æºã‚’é€šã˜ã¦æ–°ãŸãªå¸‚å ´é ˜åŸŸã‚’æ‹¡å¤§ã—ã¾ã™ã€‚æœ¬å±•ã¯ã€æœªæ¥ã‚’æ‹“ãäº‹æ¥­å¤‰é©ã®å…ˆé§†ã‘ã¨ãªã‚‹ã“ã¨ã‚’ç›®æ¨™ã¨ã—ã¾ã™ã€‚
ç‰¹åˆ¥ä¼ç”»
70å›è¨˜å¿µå±•ç¤ºã€Œé»„é‡‘ã®èŒ¶å®¤ã€ : ç¬¬60å›å±•ã§ã”å¥½è©•ã„ãŸã ã„ãŸã€Œé»„é‡‘ã®èŒ¶å®¤ã€ã‚’ç‰¹åˆ¥å±•ç¤ºã„ãŸã—ã¾ã™ã€‚ä¸­æ–­ã—ã¦ãŠã‚Šã¾ã—ãŸãŠèŒ¶ã®æä¾›ã‚‚ã€ã€Œé»„é‡‘ã®èŒ¶å®¤ã€ã«é™ã‚Šã€é™å®šæ•°ã«ã¦æœ‰æ–™ã§å†é–‹ã™ã‚‹äºˆå®šã§ã™ã€‚
ã‚¢ãƒ¼ãƒˆãƒ‘ãƒãƒ«ãƒ–ãƒ¼ã‚¹ : æ˜¨å¹´ã‚ˆã‚Šé–‹å§‹ã—ã€å¤šå¤§ãªè©•ä¾¡ã‚’ã„ãŸã ã„ã¦ã„ã‚‹ãƒ–ãƒ¼ã‚¹ã§ã™ã€‚ä»Šå¹´ã®ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸä½œå“ã‚’å‹Ÿé›†ã—ã€å‡ºå“ä½œå“ã¯æ¥å ´è€…ã«ã‚ˆã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æŠ•ç¥¨ã§è©•ä¾¡ã€ä»Šå¾Œã®ä½œå“ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã«ç¹‹ã’ã¾ã™ã€‚é«˜è©•ä¾¡ä½œå“ã«ã¯å•†å“åˆ¸ç­‰ã‚’è´ˆå‘ˆã„ãŸã—ã¾ã™ã€‚
ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ : ä¾‹å¹´é€šã‚Šã€çµ„åˆå…¬å¼WEBã‚µã‚¤ãƒˆã€SNSã€ECã‚µã‚¤ãƒˆã‚’é§†ä½¿ã—ã€æ—©æœŸã‹ã‚‰ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é›†å®¢ã‚’å¼·åŒ–ã—ã¾ã™ã€‚
ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ : äº¬éƒ½å¸‚å–¶åœ°ä¸‹é‰„æ”¹æœ­ä»˜è¿‘ã§ã®ãƒã‚¹ã‚¿ãƒ¼æ²ç¤ºã«ã‚ˆã‚Šã€åŠ¹æœçš„ãªé›†å®¢ã‚’å›³ã‚Šã¾ã™ã€‚
å‡ºå±•è¦é …
è‡ªç”±å‡ºå“ : ã€Œè‡ªç”±å‡ºå“ï¼ˆè¤’ç« å¯©æŸ»å¯¾è±¡å¤–ï¼‰ã€ã‚’å—ã‘ä»˜ã‘ã€å¤šãã®çµ„åˆå“¡ã®çš†æ§˜ã‹ã‚‰ã®ã”å¿œå‹Ÿã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚
ä½œå“èª¬æ˜ : å‡ºå“ä½œå“ã«ã¯ã€ä¾‹å¹´é€šã‚Šã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆèª¬æ˜æ–‡ï¼‰ã‚’æ·»ãˆã¦å±•ç¤ºã„ãŸã—ã¾ã™ã€‚`;

        // ---ç”»é¢ã®æ“ä½œã«é–¢ã™ã‚‹é–¢æ•°---
        function displayFileName(event) {
            const fileInput = event.target;
            const fileNameSpan = document.getElementById('fileName');
            const uploadedImage = document.getElementById('uploadedImage');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const file = fileInput.files[0];

            if (file) {
                fileNameSpan.textContent = file.name;
                uploadedImage.src = URL.createObjectURL(file);
                imagePreviewContainer.classList.remove('hidden');
            } else {
                fileNameSpan.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
                imagePreviewContainer.classList.add('hidden');
            }
        }

        // ---AIã¨ã®é€šä¿¡ã«é–¢ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°---
        async function analyzeImage() {
            const fileInput = document.getElementById('imageInput');
            const keywordsInput = document.getElementById('keywordsInput');
            const file = fileInput.files[0];
            const keywords = keywordsInput.value;
            const resultDiv = document.getElementById('imageAnalysisResult');
            const generateButton = document.querySelector('button');

            if (!file) {
                resultDiv.innerHTML = '<p class="text-red-500">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            resultDiv.innerHTML = '<div class="flex flex-col items-center space-y-2"><div class="dot-pulse"></div><p class="text-sm text-gray-500">AIãŒä½œå“ã‚’åˆ†æä¸­ã§ã™ã€‚å®Œäº†ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p></div>';
            generateButton.disabled = true;

            const reader = new FileReader();
            reader.onloadend = async () => {
                currentImageBase64 = reader.result.split(',')[1];
                currentKeywords = keywords;
                currentMimeType = file.type;
                
                const prompt = `ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ç¬¬70å›è¨˜å¿µè¡¨ç¾å±•ã«å‡ºå±•ã™ã‚‹ç§ã®ä½œå“ã«ã¤ã„ã¦ã€ä½œè€…ã§ã‚ã‚‹è¡¨å…·å¸«æœ¬äººã®ç›®ç·šã§ã€3ã¤ã®ç•°ãªã‚‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æ¡ˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
"${EXHIBITION_DOCUMENT}"

ç§ã®ä½œå“ã«ã¤ã„ã¦ã€ä¸€äººã®è¡¨å…·å¸«ã¨ã—ã¦ã€é•·å¹´åŸ¹ã£ã¦ããŸæŠ€è¡“ã‚„ç´ æã¸ã®ã“ã ã‚ã‚Šã€ãã—ã¦ã€Œä¼çµ±çš„ãªã‚‚ã®ã‹ã‚‰æ–°ã—ã„ä¾¡å€¤ã‚’ç”Ÿã¿å‡ºã™ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã¸ã®æŒ‘æˆ¦ãŒä¼ã‚ã‚‹ã‚ˆã†ã«ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ä½œå“ã®ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç‰¹å¾´ï¼ˆè‰²ã€å½¢ã€è³ªæ„Ÿã€æ§‹å›³ã€é›°å›²æ°—ãªã©ï¼‰ã«å…·ä½“çš„ã«è§¦ã‚Œã¤ã¤ã€è¡¨å…·å¸«ãªã‚‰ã§ã¯ã®å°‚é–€çš„ãªè¦–ç‚¹ã‚„ã€ä½œå“ã«è¾¼ã‚ãŸç²¾ç¥æ€§ã‚’èªã£ã¦ãã ã•ã„ã€‚
1ã¤ç›®ã®æ¡ˆã¯ã€ä½œå“ã®**æŠ€è¡“ã‚„ç´ æã®é¢ç™½ã•**ã€**å½¢ã‚„è‰²ã®ç¾ã—ã•**ã«ç„¦ç‚¹ã‚’å½“ã¦ã€å°‘ã—æ–‡å­¦çš„ã§æ·±ã¿ã®ã‚ã‚‹è¡¨ç¾ã‚’ä½¿ã£ã¦ã€ç§ãŒã“ã®ä½œå“ã«è¾¼ã‚ãŸæ€ã„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
2ã¤ç›®ã®æ¡ˆã¯ã€ä½œå“ãŒæŒã¤**ç‰©èªæ€§**ã‚„**æ„Ÿå‹•çš„ãªå´é¢**ã€**è¦‹ã‚‹äººã«èªã‚Šã‹ã‘ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ã«ç„¦ç‚¹ã‚’å½“ã¦ã€å…±æ„Ÿã‚’å‘¼ã¶ã‚ˆã†ãªè¡¨ç¾ã§ã€ç§ãŒã“ã®ä½œå“ã‚’é€šã—ã¦ä¼ãˆãŸã„ã“ã¨ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
3ã¤ç›®ã®æ¡ˆã¯ã€ä½œå“ã®**è¦‹ãŸç›®ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ**ã¨ã€ãã“ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹**æ–°ã—ã„è¡¨ç¾ã®å¯èƒ½æ€§**ã«ç„¦ç‚¹ã‚’å½“ã¦ã€å±•ç¤ºã®å ´ã§ç›®ã‚’å¼•ãã‚ˆã†ãªåŠ›å¼·ã„è¡¨ç¾ã§ã€ç§ã®è¡¨ç¾ã¸ã®æŒ‘æˆ¦ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

é‡è¦: å„ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¯ã€å±•è¦§ä¼šå ´ã§æ¥å ´è€…ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã€100æ–‡å­—ã‹ã‚‰150æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ã•ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚å„ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¯ç‹¬ç«‹ã—ãŸæ–‡ç« ã¨ã—ã¦å®Œçµã•ã›ã€è¦‹å‡ºã—ã‚„ç®‡æ¡æ›¸ãã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
ã€Œæ¸©æ•…å‰µæ–°ã€ã¨ã„ã†è¨€è‘‰ã‚’ç›´æ¥ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

${keywords ? `\nä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã«åæ˜ ã•ã›ã¦ãã ã•ã„: ${keywords}` : ''}`;
                    
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: currentMimeType, data: currentImageBase64 } }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: { "caption": { "type": "STRING" } },
                                "propertyOrdering": ["caption"]
                            }
                        }
                    }
                };

                try {
                    const result = await fetchWithRetry(apiUrl, payload);
                    
                    if (!result) throw new Error('APIã‹ã‚‰ç©ºã®å¿œç­”ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚');
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const rawJsonText = result.candidates[0].content.parts[0].text;
                        let captions;
                        try {
                            captions = JSON.parse(rawJsonText);
                        } catch (e) {
                            const jsonMatch = rawJsonText.match(/\[\s*\{[\s\S]*\}\s*\]/);
                            if (jsonMatch && jsonMatch[0]) { captions = JSON.parse(jsonMatch[0]); } 
                            else { throw new Error('APIå¿œç­”ã«æœ‰åŠ¹ãªJSONãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
                        }
                        
                        if (!Array.isArray(captions) || captions.length < 3 || !captions[0].caption) {
                            throw new Error('ç„¡åŠ¹ãªJSONæ§‹é€ ã§ã™ã€‚');
                        }

                        let resultHtml = `
                            <div class="space-y-6">
                                ${captions.map((item, index) => `
                                    <div class="p-4 rounded-md card">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                            <h3 class="font-bold text-md sm:text-lg text-left text-[#4A4A4A]">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æ¡ˆ${index + 1}</h3>
                                            <div class="flex space-x-2 self-end sm:self-auto">
                                                <button onclick="copyToClipboard(this)" class="button text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors whitespace-nowrap">ã‚³ãƒ”ãƒ¼</button>
                                                <button onclick="downloadCaption(\`${escapeHtml(item.caption)}\`, ${index + 1})" class="button text-sm px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors whitespace-nowrap">ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜</button>
                                                <button onclick="startChat(${index}, \`${escapeHtml(item.caption)}\`)" class="button text-sm px-3 py-1 bg-[#0E4D92] text-white rounded-md hover:bg-[#1263B7] whitespace-nowrap">AIã¨ãƒãƒ£ãƒƒãƒˆ</button>
                                            </div>
                                        </div>
                                        <p class="mt-4 text-left caption-text" data-index="${index}">${escapeHtml(item.caption)}</p>
                                        <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 justify-between items-center">
                                            <div class="flex items-center gap-2">
                                                <button onclick="speakText(this, \`${escapeHtml(item.caption)}\`, 'ja-JP')" class="button text-sm px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">ğŸ”Š æ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                                <button onclick="downloadStoredAudio(this)" data-lang="ja-JP" disabled class="button text-sm px-3 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                                                <button onclick="speakText(this, \`${escapeHtml(item.caption)}\`, 'en-US')" class="button text-sm px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">ğŸ”Š è‹±èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                                <button onclick="downloadStoredAudio(this)" data-lang="en-US" disabled class="button text-sm px-3 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                                            </div>
                                            <button onclick="generateSocialMediaPost(${index}, \`${escapeHtml(item.caption)}\`)" class="button text-sm px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">âœ¨ SNSæŠ•ç¨¿ã‚’ä½œæˆ</button>
                                        </div>
                                        <div id="extra-content-${index}" class="mt-4 text-left"></div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        resultDiv.innerHTML = resultHtml;

                    } else { throw new Error('APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    let errorMessage;
                    if (error.message && error.message.includes('403')) {
                        errorMessage = `<div class="text-left">...</div>`;
                    } else { errorMessage = `<p class="text-red-500">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: ${error.message}</p>`; }
                    resultDiv.innerHTML = errorMessage;
                } finally {
                    generateButton.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }
        
        // ---AIã¨ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã«é–¢ã™ã‚‹é–¢æ•°---
        async function startChat(captionIndex, initialCaption) {
            const resultDiv = document.getElementById('imageAnalysisResult');
            const chatHtml = `
                <div id="chatInterface" class="space-y-4">
                    <button onclick="resetApp()" class="button text-sm py-1 px-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors mb-4">â† æœ€åˆã®ç”»é¢ã«æˆ»ã‚‹</button>
                    <div id="chatHistory" class="h-64 sm:h-80 overflow-y-auto p-2 sm:p-4 bg-gray-50 rounded-md border border-gray-200">
                        <div class="flex items-start mb-4">
                            <span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-[#0E4D92] text-white font-bold mr-2 sm:mr-3 text-sm">AI</span>
                            <div class="p-2 sm:p-3 bg-white rounded-lg shadow-sm w-full">
                                <p class="text-sm sm:text-base">ã“ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã€ã©ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ</p>
                                <p class="mt-2 text-xs sm:text-sm text-gray-500 caption-text break-words">"${initialCaption}"</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" placeholder="ä¾‹ï¼šã‚‚ã£ã¨çŸ­ãã—ã¦ãã ã•ã„" class="text-sm sm:text-base flex-grow p-2 rounded-l-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#0E4D92] transition-all">
                        <button onclick="sendChatMessage()" class="button py-2 px-4 sm:px-6 bg-[#0E4D92] text-white rounded-r-md hover:bg-[#1263B7] text-sm sm:text-base">é€ä¿¡</button>
                    </div>
                </div>
            `;
            resultDiv.innerHTML = chatHtml;
            document.getElementById('chatInput').focus();
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value;
            const chatHistory = document.getElementById('chatHistory');
            
            if (!userMessage.trim()) return;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = "flex items-start justify-end mb-4";
            userMessageDiv.innerHTML = `
                <div class="p-2 sm:p-3 bg-[#EBF5FF] rounded-lg shadow-sm max-w-[80%]">
                    <p class="text-sm sm:text-base break-words">${escapeHtml(userMessage)}</p>
                </div>
                <span class="flex-shrink-0 inline-flex items-center justify-center h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-gray-400 text-white font-bold ml-2 sm:ml-3 text-sm">ã‚ãªãŸ</span>
            `;
            chatHistory.appendChild(userMessageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            chatInput.value = "";
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = "loadingIndicator";
            loadingDiv.className = "flex items-start mb-4";
            loadingDiv.innerHTML = `<span class="flex-shrink-0 ...">AI</span><div class="p-2 ..."><div class="dot-pulse"></div></div>`;
            chatHistory.appendChild(loadingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            const currentCaptionElement = document.getElementById('chatHistory').querySelector('p.caption-text');
            const currentCaption = currentCaptionElement ? currentCaptionElement.textContent.trim().replace(/^"/, '').replace(/"$/, '') : "";
            
            try {
                const prompt = `ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«æ²¿ã£ã¦ã€ä½œè€…ã§ã‚ã‚‹è¡¨å…·å¸«ã®è¦–ç‚¹ã‚’ã‚ˆã‚Šå¼·ãåæ˜ ã•ã›ã¦å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\nç¾åœ¨ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³: "${currentCaption}"\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º: "${userMessage}"\n${currentKeywords ? `ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„: ${currentKeywords}` : ''}`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: currentMimeType, data: currentImageBase64 } }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { "caption": { "type": "STRING" } }, "propertyOrdering": ["caption"] }
                    }
                };
                
                const result = await fetchWithRetry(apiUrl, payload);
                loadingDiv.remove();
                
                if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    const rawJsonText = result.candidates[0].content.parts[0].text;
                    let newCaption;
                    try { newCaption = JSON.parse(rawJsonText).caption; } catch (e) {
                        const captionMatch = rawJsonText.match(/"caption"\s*:\s*"(.*?)"/s);
                        newCaption = captionMatch ? captionMatch[1] : rawJsonText;
                    }
                    
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = "flex items-start mb-4";
                    aiMessageDiv.innerHTML = `
                        <span class="flex-shrink-0 ...">AI</span>
                        <div class="p-2 sm:p-3 bg-white rounded-lg shadow-sm w-full">
                            <p class="text-sm sm:text-base break-words">${escapeHtml(newCaption)}</p>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 items-center">
                                <button onclick="copyToClipboard(this)" class="button text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md">ã‚³ãƒ”ãƒ¼</button>
                                <button onclick="downloadCaption(\`${escapeHtml(newCaption)}\`, 0)" class="button text-xs px-2 py-1 bg-gray-500 text-white rounded-md">ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜</button>
                                <button onclick="speakText(this, \`${escapeHtml(newCaption)}\`, 'ja-JP')" class="button text-xs px-2 py-1 bg-red-600 text-white rounded-md">ğŸ”Š æ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                <button onclick="downloadStoredAudio(this)" data-lang="ja-JP" disabled class="button text-xs px-2 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                                <button onclick="speakText(this, \`${escapeHtml(newCaption)}\`, 'en-US')" class="button text-xs px-2 py-1 bg-indigo-500 text-white rounded-md">ğŸ”Š è‹±èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                <button onclick="downloadStoredAudio(this)" data-lang="en-US" disabled class="button text-xs px-2 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                            </div>
                        </div>
                    `;
                    chatHistory.appendChild(aiMessageDiv);
                    chatHistory.scrollTop = chatHistory.scrollHeight;

                    if (currentCaptionElement) { currentCaptionElement.textContent = `"${escapeHtml(newCaption)}"`; }
                } else { throw new Error('APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
            } catch (error) {
                console.error('Error in chat:', error);
                loadingDiv.remove();
                // ... error handling
            }
        }

        // --- SNSæŠ•ç¨¿æ©Ÿèƒ½ ---
        async function generateSocialMediaPost(index, caption) {
            const extraContentDiv = document.getElementById(`extra-content-${index}`);
            extraContentDiv.innerHTML = '<div class="p-4 bg-gray-50 rounded-lg"><div class="..."><div class="dot-pulse"></div><p class="...">AIãŒSNSæŠ•ç¨¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™...</p></div></div>';

            try {
                const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®SNSãƒãƒ¼ã‚±ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ä½œå“ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ƒã«ã€è¦‹ãŸäººãŒã€Œã„ã„ã­ï¼ã€ã‚’æŠ¼ã—ãŸããªã‚‹ã‚ˆã†ãªã€å¥½æ„Ÿåº¦ã®é«˜ã„Instagramã®æŠ•ç¨¿æ–‡ã‚’ã€ç°¡æ½”ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚ä½œè€…ï¼ˆè¡¨å…·å¸«ï¼‰ã®ä½œå“ã¸ã®æƒ³ã„ã‚„ã“ã ã‚ã‚ŠãŒã€è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤é­…åŠ›çš„ã«ä¼ã‚ã‚‹ã‚ˆã†ãªæ–‡ç« ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚æœ€å¾Œã«ã€å±•è¦§ä¼šã®æƒ…å ±ï¼ˆç¬¬70å›è¨˜å¿µè¡¨ç¾å±•ã€ä¼šå ´ï¼šã¿ã‚„ã“ã‚ã£ã›ï¼‰ã¨ã€åŠ¹æœçš„ãªãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆ#ç¬¬70å›è¨˜å¿µè¡¨ç¾å±• #æ¸©æ•…å‰µæ–° #äº¬éƒ½è¡¨å…·å”åŒçµ„åˆ #è¡¨ç¾å±• #äº¬éƒ½ #è¡¨å…· #ä¼çµ±å·¥èŠ¸ #ã‚¢ãƒ¼ãƒˆãªã©ï¼‰ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚\n\nã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³:\nã€Œ${caption}ã€`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                     generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: { "post": { "type": "STRING" } },
                            "propertyOrdering": ["post"]
                        }
                    }
                };

                const result = await fetchWithRetry(apiUrl, payload);
                 if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    const post = JSON.parse(result.candidates[0].content.parts[0].text).post;
                    let postHtml = `
                        <div class="p-4 bg-gray-50 rounded-lg extra-content-card">
                            <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <h4 class="font-bold text-md text-gray-800">SNSæŠ•ç¨¿æ¡ˆ</h4>
                                <div class="flex items-center gap-2">
                                     <button onclick="copyToClipboard(this)" class="button text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">ã‚³ãƒ”ãƒ¼</button>
                                     <button onclick="downloadCaption(\`${escapeHtml(post)}\`, 'sns')" class="button text-sm px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600">ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜</button>
                                     <button onclick="startSocialChat(${index}, \`${escapeHtml(post)}\`)" class="button text-sm px-3 py-1 bg-[#0E4D92] text-white rounded-md hover:bg-[#1263B7]">AIã¨ãƒãƒ£ãƒƒãƒˆ</button>
                                     <button onclick="clearExtraContent(${index})" class="text-sm text-gray-500 hover:text-gray-800">é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                            <p class="sns-post">${escapeHtml(post)}</p>
                        </div>`;
                    extraContentDiv.innerHTML = postHtml;
                } else { throw new Error('APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
            } catch (error) {
                console.error('Error generating social media post:', error);
                extraContentDiv.innerHTML = `<p class="text-red-500 text-sm">SNSæŠ•ç¨¿ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }
        
        async function startSocialChat(captionIndex, initialPost) {
            const resultDiv = document.getElementById('imageAnalysisResult');
            const chatHtml = `
                <div id="chatInterface" class="space-y-4">
                    <button onclick="resetApp()" class="button text-sm py-1 px-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors mb-4">â† æœ€åˆã®ç”»é¢ã«æˆ»ã‚‹</button>
                    <div id="chatHistory" class="h-64 sm:h-80 overflow-y-auto p-2 sm:p-4 bg-gray-50 rounded-md border border-gray-200">
                        <div class="flex items-start mb-4">
                            <span class="... mr-2 sm:mr-3 ...">AI</span>
                            <div class="p-2 sm:p-3 bg-white rounded-lg shadow-sm w-full">
                                <p class="text-sm sm:text-base">ã“ã®SNSæŠ•ç¨¿ã‚’ã€ã©ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ</p>
                                <p class="mt-2 text-xs sm:text-sm text-gray-500 sns-post break-words">${initialPost}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" placeholder="ä¾‹ï¼šã‚‚ã£ã¨è¦ªã—ã¿ã‚„ã™ã„æ„Ÿã˜ã«" class="... flex-grow ...">
                        <button onclick="sendSocialChatMessage()" class="button ...">é€ä¿¡</button>
                    </div>
                </div>
            `;
            resultDiv.innerHTML = chatHtml;
            document.getElementById('chatInput').focus();
        }

        async function sendSocialChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value;
            const chatHistory = document.getElementById('chatHistory');

            if (!userMessage.trim()) return;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = "flex items-start justify-end mb-4";
            userMessageDiv.innerHTML = `...`;
            chatHistory.appendChild(userMessageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            chatInput.value = "";
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = "loadingIndicator";
            loadingDiv.className = "flex items-start mb-4";
            loadingDiv.innerHTML = `<span class="...">AI</span><div class="..."><div class="dot-pulse"></div></div>`;
            chatHistory.appendChild(loadingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const postElements = chatHistory.querySelectorAll('.sns-post');
            const currentPost = postElements.length > 0 ? postElements[postElements.length - 1].textContent.trim() : "";

            try {
                const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®SNSãƒãƒ¼ã‚±ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®InstagramæŠ•ç¨¿æ–‡ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«æ²¿ã£ã¦ã€ã‚ˆã‚Šå¥½æ„Ÿåº¦ãŒé«˜ãã€ç°¡æ½”ã«ãªã‚‹ã‚ˆã†ã«å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ä½œè€…ï¼ˆè¡¨å…·å¸«ï¼‰ã®ä½œå“ã¸ã®æƒ³ã„ãŒè¦ªã—ã¿ã‚„ã™ãä¼ã‚ã‚‹ã‚ˆã†ã«ã—ã€å±•è¦§ä¼šã®æƒ…å ±ã¨æŒ‡å®šã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆ#ç¬¬70å›è¨˜å¿µè¡¨ç¾å±• #æ¸©æ•…å‰µæ–° #äº¬éƒ½è¡¨å…·å”åŒçµ„åˆãªã©ï¼‰ã¯å¿…ãšç¶­æŒã—ã¦ãã ã•ã„ã€‚\n\nç¾åœ¨ã®æŠ•ç¨¿æ–‡:\nã€Œ${currentPost}ã€\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º:\nã€Œ${userMessage}ã€`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { "post": { "type": "STRING" } }, "propertyOrdering": ["post"] }
                    }
                };
                
                const result = await fetchWithRetry(apiUrl, payload);
                loadingDiv.remove();
                
                if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    const newPost = JSON.parse(result.candidates[0].content.parts[0].text).post;
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = "flex items-start mb-4";
                    aiMessageDiv.innerHTML = `
                        <span class="... mr-2 sm:mr-3 ...">AI</span>
                        <div class="p-2 sm:p-3 bg-white rounded-lg shadow-sm w-full">
                            <p class="text-sm sm:text-base break-words sns-post">${escapeHtml(newPost)}</p>
                             <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2 items-center">
                                <button onclick="copyToClipboard(this)" class="button text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md">ã‚³ãƒ”ãƒ¼</button>
                                <button onclick="downloadCaption(\`${escapeHtml(newPost)}\`, 'sns')" class="button text-xs px-2 py-1 bg-gray-500 text-white rounded-md">ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜</button>
                                <button onclick="speakText(this, \`${escapeHtml(newPost)}\`, 'ja-JP')" class="button text-xs px-2 py-1 bg-red-600 text-white rounded-md">ğŸ”Š æ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                <button onclick="downloadStoredAudio(this)" data-lang="ja-JP" disabled class="button text-xs px-2 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                                <button onclick="speakText(this, \`${escapeHtml(newPost)}\`, 'en-US')" class="button text-xs px-2 py-1 bg-indigo-500 text-white rounded-md">ğŸ”Š è‹±èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                                <button onclick="downloadStoredAudio(this)" data-lang="en-US" disabled class="button text-xs px-2 py-1 bg-gray-400 text-white rounded-md">ğŸ’¾ ä¿å­˜</button>
                            </div>
                        </div>
                    `;
                    chatHistory.appendChild(aiMessageDiv);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                } else { throw new Error('APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
            } catch (error) {
                console.error('Error in social chat:', error);
                loadingDiv.remove();
                // ... (error handling)
            }
        }
        
        // ---è£œåŠ©çš„ãªé–¢æ•°---
        
        // â˜…â˜…â˜… éŸ³å£°å‡ºåŠ›æ©Ÿèƒ½ (Gemini TTS APIç‰ˆ) â˜…â˜…â˜…
        async function speakText(buttonElement, text, lang) {
            // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã¨ã®äº’æ›æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«AudioContextã‚’åˆæœŸåŒ–
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                    const errorSpan = document.createElement('span');
                    errorSpan.className = 'text-xs text-red-500 ml-2';
                    errorSpan.textContent = 'éŸ³å£°å†ç”Ÿã«éå¯¾å¿œã§ã™';
                    buttonElement.after(errorSpan);
                    setTimeout(() => { errorSpan.remove(); }, 3000);
                    buttonElement.disabled = true;
                    return;
                }
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const originalButtonText = buttonElement.textContent;
            const downloadBtn = buttonElement.nextElementSibling;
            let textToSpeak = text;

            try {
                if (lang.startsWith('en')) {
                    buttonElement.textContent = "ç¿»è¨³ä¸­...";
                    buttonElement.disabled = true;
                    const translatedText = await translateText(text, 'en');
                    if (!translatedText) throw new Error('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    textToSpeak = translatedText;
                }
                
                buttonElement.textContent = "éŸ³å£°ç”Ÿæˆä¸­...";
                buttonElement.disabled = true;
                if (downloadBtn) downloadBtn.disabled = true;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
                const prompt = lang.startsWith('ja') 
                    ? `ã“ã‚Œã¯ç¾è¡“ä½œå“ã®è§£èª¬æ–‡ã§ã™ã€‚æ–‡è„ˆã«æ³¨æ„ã—ã¦ã€ç‰¹ã«æ¼¢å­—ã®èª­ã¿æ–¹ï¼ˆéŸ³èª­ã¿ã€è¨“èª­ã¿ï¼‰ãŒæ­£ç¢ºã«ãªã‚‹ã‚ˆã†ã«ã€è¦ªã—ã¿ã‚„ã™ãã€æŠ‘æšã‚’ã¤ã‘ã¦èª­ã‚“ã§ãã ã•ã„: ${textToSpeak}`
                    : `Read this with a friendly and expressive tone: ${textToSpeak}`;
                const payload = {
                    model: "gemini-2.5-flash-preview-tts",
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: lang.startsWith('ja') ? "Puck" : "Callirrhoe" }
                            }
                        }
                    }
                };

                const result = await fetchWithRetry(apiUrl, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("MIMEã‚¿ã‚¤ãƒ—ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    // Web Audio API ã‚’ä½¿ã£ã¦å†ç”Ÿ
                    const arrayBuffer = await wavBlob.arrayBuffer();
                    audioContext.decodeAudioData(arrayBuffer, (buffer) => {
                        const source = audioContext.createBufferSource();
                        source.buffer = buffer;
                        source.connect(audioContext.destination);
                        source.start(0);
                    }, (error) => {
                        console.error("éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                        throw new Error("éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    });

                    if (downloadBtn) {
                        const audioUrl = URL.createObjectURL(wavBlob);
                        downloadBtn.dataset.audioUrl = audioUrl;
                        downloadBtn.disabled = false;
                    }

                } else {
                    throw new Error("APIã‹ã‚‰æœ‰åŠ¹ãªéŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                }

            } catch (error) {
                console.error("éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                const errorSpan = document.createElement('span');
                errorSpan.className = 'text-xs text-red-500 ml-2';
                errorSpan.textContent = 'éŸ³å£°ç”Ÿæˆã«å¤±æ•—';
                buttonElement.after(errorSpan);
                setTimeout(() => { errorSpan.remove(); }, 3000);
            } finally {
                buttonElement.textContent = originalButtonText;
                buttonElement.disabled = false;
            }
        }
        
        function downloadStoredAudio(buttonElement) {
            const audioUrl = buttonElement.dataset.audioUrl;
            if (!audioUrl) {
                console.error("éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const lang = buttonElement.dataset.lang;
            const filename = lang.startsWith('ja') ? 'caption_jp.wav' : 'caption_en.wav';
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadCaption(text, index) {
            const filename = typeof index === 'number' ? `caption_an_${index}.txt` : `sns_post.txt`;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        async function translateText(text, targetLang) {
            try {
                const langName = targetLang === 'en' ? 'English' : 'Japanese';
                const prompt = `Translate the following Japanese text to ${langName}:\n\n"${text}"`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: { "translation": { "type": "STRING" } },
                            "propertyOrdering": ["translation"]
                        }
                    }
                };
                const result = await fetchWithRetry(apiUrl, payload);
                if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    const translation = JSON.parse(result.candidates[0].content.parts[0].text).translation;
                    return translation;
                } else {
                    throw new Error('APIã‹ã‚‰æœ‰åŠ¹ãªç¿»è¨³ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                 console.error("Translation error:", error);
                 return null;
            }
        }
        function resetApp() {
            const resultDiv = document.getElementById('imageAnalysisResult');
            resultDiv.innerHTML = '<p class="text-gray-400">ã“ã“ã«AIã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
            document.getElementById('imageInput').value = '';
            document.getElementById('keywordsInput').value = '';
            document.getElementById('fileName').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            currentImageBase64 = null;
            currentKeywords = "";
            currentMimeType = null;
        }
        async function fetchWithRetry(url, payload, retries = 3) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("API Error Response:", errorText);
                        if (response.status >= 400 && response.status < 500) {
                             throw new Error(`API returned client error: ${response.status} ${response.statusText}`);
                        }
                        throw new Error(`API returned server error: ${response.status} ${response.statusText}`);
                    }
                    
                    // TTS API can return an empty successful response.
                    if (response.headers.get("content-length") === "0" || response.status === 204) {
                         if (url.includes('gemini-2.5-flash-preview-tts')) {
                             console.warn("TTS API returned an empty successful response.");
                             return {}; // Return an empty object to avoid breaking the logic
                        }
                    }
                    
                    const responseText = await response.text();
                     if (!responseText) {
                        throw new Error('API returned an empty successful response.');
                    }
                    
                    return JSON.parse(responseText);

                } catch (error) {
                    lastError = error;
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 200;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }
            throw lastError || new Error("All API retries failed without a specific error.");
        }
        function copyToClipboard(buttonElement) {
            const container = buttonElement.closest('.extra-content-card') || buttonElement.closest('.card') || buttonElement.closest('div.bg-white');
            const textElement = container.querySelector('.sns-post') || container.querySelector('.caption-text') || container.querySelector('p:not([class*="text-gray-500"])');
            
            if (textElement) {
                const textToCopy = textElement.textContent;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                    setTimeout(() => {
                       buttonElement.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            } else {
                 console.error('Could not find text element to copy.');
            }
        }
        function clearExtraContent(index) {
            document.getElementById(`extra-content-${index}`).innerHTML = '';
        }
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>


